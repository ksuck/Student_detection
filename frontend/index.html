<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Face Recognition</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
      background: #f0f0f0;
    }
    video {
      border: 2px solid #333;
      border-radius: 10px;
    }
    #name {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
      color: #2c3e50;
    }
    #timer {
      margin-top: 10px;
      font-size: 18px;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>Face Recognition (Every 5 seconds)</h2>
  <video id="video" width="640" height="480" autoplay muted></video>
  <div id="name">Name: -</div>
  <div id="timer">Next check in: 5s</div>

  <script>
    const video = document.getElementById('video');
    const nameDiv = document.getElementById('name');
    const timerDiv = document.getElementById('timer');

    let countdown = 5;
    let intervalId;

    // ขอสิทธิ์ใช้กล้อง
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;

        intervalId = setInterval(() => {
          captureFrameAndSend();
        }, 5000);

        // countdown display
        setInterval(() => {
          countdown--;
          if (countdown <= 0) {
            countdown = 5;
          }
          timerDiv.textContent = `Next check in: ${countdown}s`;
        }, 1000);
      })
      .catch(err => {
        console.error("Cannot access camera: ", err);
      });

    async function captureFrameAndSend() {
      countdown = 5; // reset timer

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
      const formData = new FormData();
      formData.append("file", blob, "frame.jpg");

      try {
        const res = await fetch("http://127.0.0.1:8000/recognize", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (data.name) {
          nameDiv.textContent = `Name: ${data.name}`;
        } else {
          nameDiv.textContent = "Name: Unknown";
        }
      } catch (err) {
        console.error("Error sending frame:", err);
      }
    }
  </script>
</body>
</html>
